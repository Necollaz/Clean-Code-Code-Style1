using System.Text;
using System.Data;

public interface IPassportCheckerView
{
    public string PassportText { get; }
    public void SetResultText(string text);
    public void ShowMessage(string message);
}

public interface IHasher
{
    string ComputeSha256Hash(string rawData);
}

public class Hasher : IHasher
{
    public string ComputeSha256Hash(string rawData)
    {
        using (var sha256 = System.Security.Cryptography.SHA256.Create())
        {
            byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(rawData));
            StringBuilder builder = new StringBuilder();
            for (int i = 0; i < bytes.Length; i++)
            {
                builder.Append(bytes[i].ToString("x2"));
            }
            return builder.ToString();
        }
    }
}

public class Citizen
{
    public Citizen(bool? hasAcces)
    {
        if (hasAcces == null)
            throw new ArgumentException(nameof(hasAcces));

        HasAccess = hasAcces;
    }

    public bool? HasAccess { get; private set; }
}

public class Passport
{
    public Passport(string passportEntry, int minPassportLenght)
    {
        if (string.IsNullOrEmpty(passportEntry))
            throw new ArgumentException("Введите серию и номер паспорта.");

        string trimmedEntry = passportEntry.Trim();
        string rawData = trimmedEntry.Replace(" ", string.Empty);

        if (rawData.Length < minPassportLenght)
            throw new ArgumentException("Неверный формат серии или номера паспорта.");

        RawData = rawData;
    }

    public string RawData { get; private set; }
}

public class DataReader
{
    public bool? ReadAccess(DataTable dataTable)
    {
        if (dataTable.Rows.Count > 0)
            return Convert.ToBoolean(dataTable.Rows[0].ItemArray[1]);

        return null;
    }
}

public class DataTableProvider
{
    private readonly string _connectionString;

    public DataTableProvider(string connectionString)
    {
        if (string.IsNullOrEmpty(connectionString))
            throw new ArgumentException(nameof(connectionString));

        _connectionString = connectionString;
    }

    public DataTable GetData(string commandText)
    {
        DataTable dataTable = new DataTable();

        using (SQLiteConnection connection = new SQLiteConnection(_connectionString))
        {
            connection.Open();

            using (SQLiteDataAdapter sqLiteDataAdapter = new SQLiteDataAdapter(new SQLiteCommand(commandText, connection)))
            {
                sqLiteDataAdapter.Fill(dataTable);
            }
        }

        return dataTable;
    }
}

public class PassportPresenterFactory
{
    private readonly string _connectionString;

    public PassportPresenterFactory(string connectionString)
    {
        if (string.IsNullOrEmpty(connectionString))
            throw new ArgumentException(nameof(connectionString));

        _connectionString = connectionString;
    }

    public PassportCheckerPresenter Create(IPassportCheckerView passportView)
    {
        var dataTableProvider = new DataTableProvider(_connectionString);
        var dataReader = new DataReader();
        var hasher = new Hasher();
        var model = new PassportCheckerModel(dataTableProvider, dataReader, hasher);

        return new PassportCheckerPresenter(passportView, model);
    }
}

public class PassportCheckerView : IPassportCheckerView
{
    private readonly PassportCheckerPresenter _presenter;

    public PassportCheckerView(PassportPresenterFactory passportPresenterFactory)
    {
        _presenter = passportPresenterFactory.Create(this);
    }

    public string PassportText => PassportTextbox.text;

    public void SetResultText(string text)
    {
        textResult.Text = text;
    }

    public void ShowMessage(string message)
    {
        MessageBox.Show(message);
    }

    private void checkButton_Click(object sender, EventArgs e)
    {
        _presenter.OnCheckButtonClicked(PassportText);
    }
}

public class PassportCheckerModel
{
    private readonly DataTableProvider _dataTableProvider;
    private readonly DataReader _dataReader;
    private readonly IHasher _hasher;

    public PassportCheckerModel(DataTableProvider dataTableProvider, DataReader dataReader, IHasher hasher)
    {
        _dataTableProvider = dataTableProvider ?? throw new ArgumentNullException(nameof(dataTableProvider));
        _dataReader = dataReader ?? throw new ArgumentNullException(nameof(dataReader));
        _hasher = hasher ?? throw new ArgumentNullException(nameof(hasher));
    }

    public Citizen Check(string rawData)
    {
        if (string.IsNullOrEmpty(rawData))
            throw new ArgumentException(nameof(rawData));

        string commandText = $"select * from passports where num='{Form1.ComputeSha256Hash(rawData)}' limit 1;";

        DataTable dataTable = _dataTableProvider.GetData(commandText);

        bool? hasAccess = _dataReader.ReadAccess(dataTable);

        return new Citizen(hasAccess);
    }
}

public class PassportCheckerPresenter
{
    private PassportCheckerModel _model;
    private IPassportCheckerView _view;
    private readonly int _minimumPassportLength = 10;

    public PassportCheckerPresenter(IPassportCheckerView view, PassportCheckerModel model)
    {
        _model = model ?? throw new ArgumentNullException(nameof(model));
        _view = view ?? throw new ArgumentNullException(nameof(view));
    }

    public void OnCheckButtonClicked(string passportEntry)
    {
        try
        {
            var passport = new Passport(passportEntry, _minimumPassportLength);
            var citizen = _model.Check(passport.RawData);

            _view.SetResultText(citizen.HasAccess switch
            {
                true => $"По паспорту «{passport.RawData}» доступ к бюллетеню на дистанционном электронном голосовании ПРЕДОСТАВЛЕН",
                false => $"По паспорту «{passport.RawData}» доступ к бюллетеню на дистанционном электронном голосовании НЕ ПРЕДОСТАВЛЯЛСЯ",
                _ => $"Паспорт «{passport.RawData}» в списке участников дистанционного голосования НЕ НАЙДЕН"
            });
        }
        catch (ArgumentException exception)
        {
            _view.ShowMessage(exception.Message);
        }
        catch (SQLiteException)
        {
            _view.ShowMessage("Файл db.sqlite не найден. Положите файл в папку вместе с exe.");
        }
    }
}
